<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XTN - Chuy·ªÉn Excel sang JSON</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #8bb8e8;
            margin-bottom: 30px;
        }

        .upload-area {
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed #4a90d9;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #6bb3ff;
        }

        .upload-area i {
            font-size: 48px;
            color: #4a90d9;
            margin-bottom: 15px;
        }

        .upload-area p {
            color: #b0c4de;
        }

        #file-input {
            display: none;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: 700;
            color: #6bb3ff;
        }

        .stat-card .label {
            color: #8bb8e8;
            font-size: 14px;
        }

        .stat-card.error .number {
            color: #ff6b6b;
        }

        .stat-card.duplicate .number {
            color: #ffc107;
        }

        .result-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .result-area.show {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4a90d9;
        }

        .json-output {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            color: #a0d2ff;
        }

        .duplicates-list {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .duplicates-list h4 {
            color: #ffc107;
            margin-bottom: 10px;
        }

        .duplicates-list ul {
            list-style: none;
            max-height: 150px;
            overflow-y: auto;
        }

        .duplicates-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 193, 7, 0.2);
            font-size: 13px;
        }

        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a90d9, #2d6cb5);
            color: #fff;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: #fff;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #000;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mapping-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .mapping-info h3 {
            margin-bottom: 15px;
            color: #6bb3ff;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }

        .mapping-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .mapping-item code {
            color: #6bb3ff;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <h1>üéã XTN 2026 - Excel to JSON Converter</h1>
        <p class="subtitle">Chuy·ªÉn ƒë·ªïi danh s√°ch chi·∫øn sƒ© t·ª´ Excel sang JSON</p>

        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <i class="fa-solid fa-file-excel"></i>
            <p>Click ho·∫∑c k√©o th·∫£ file Excel v√†o ƒë√¢y</p>
            <p style="font-size:12px; margin-top:10px; color:#6bb3ff;">H·ªó tr·ª£: .xlsx, .xls</p>
            <input type="file" id="file-input" accept=".xlsx,.xls">
        </div>

        <div class="stats" id="stats" style="display:none;">
            <div class="stat-card">
                <div class="number" id="total-count">0</div>
                <div class="label">T·ªïng d√≤ng</div>
            </div>
            <div class="stat-card">
                <div class="number" id="valid-count">0</div>
                <div class="label">H·ª£p l·ªá</div>
            </div>
            <div class="stat-card duplicate">
                <div class="number" id="duplicate-count">0</div>
                <div class="label">Email tr√πng</div>
            </div>
            <div class="stat-card error">
                <div class="number" id="error-count">0</div>
                <div class="label">L·ªói</div>
            </div>
        </div>

        <div class="result-area" id="result-area">
            <div id="duplicates-container"></div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('json')">JSON Output</button>
                <button class="tab" onclick="showTab('preview')">Preview Table</button>
            </div>

            <div id="json-tab">
                <div class="json-output" id="json-output"></div>
            </div>
            <div id="preview-tab" style="display:none;">
                <div style="overflow-x:auto;">
                    <table id="preview-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                    </table>
                </div>
            </div>

            <div class="actions" style="margin-top:20px;">
                <button class="btn btn-primary" onclick="copyJSON()">
                    <i class="fa-solid fa-copy"></i> Copy JSON
                </button>
                <button class="btn btn-success" onclick="downloadJSON()">
                    <i class="fa-solid fa-download"></i> T·∫£i JSON
                </button>
                <button class="btn btn-warning" onclick="downloadCleanExcel()">
                    <i class="fa-solid fa-file-excel"></i> T·∫£i Excel (ƒë√£ l·ªçc tr√πng)
                </button>
                <button class="btn" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;"
                    onclick="importToFirebase()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Import v√†o Firebase
                </button>
            </div>

            <div id="import-progress"
                style="display:none; margin-top:15px; background:rgba(0,0,0,0.3); border-radius:8px; padding:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span id="import-status">ƒêang import...</span>
                    <span id="import-count">0/0</span>
                </div>
                <div style="background:rgba(255,255,255,0.2); border-radius:4px; height:8px; overflow:hidden;">
                    <div id="import-bar"
                        style="background:linear-gradient(90deg,#4ade80,#22c55e); height:100%; width:0%; transition:width 0.3s;">
                    </div>
                </div>
            </div>
        </div>

        <div class="mapping-info">
            <h3>üìã Mapping Rules</h3>
            <div class="mapping-grid">
                <div class="mapping-item">H·ªç v√† t√™n ‚Üí <code>name</code></div>
                <div class="mapping-item">MSSV ‚Üí <code>mssv</code></div>
                <div class="mapping-item">Email ‚Üí <code>email</code></div>
                <div class="mapping-item">S·ªë ƒëi·ªán tho·∫°i ‚Üí <code>phone</code></div>
                <div class="mapping-item">ƒê·ªôi h√¨nh ‚Üí <code>team_id</code> (slug)</div>
                <div class="mapping-item">Ch·ª©c v·ª• ‚Üí <code>position</code> + <code>role</code></div>
            </div>

            <h4 style="margin-top:15px; color:#ff6b6b;">üîê Role Mapping (theo Ch·ª©c v·ª•):</h4>
            <div class="mapping-grid" style="margin-top:10px;">
                <div class="mapping-item" style="background:#dc2626;color:white;">Ch·ªâ huy Tr∆∞·ªüng ‚Üí
                    <code>super_admin</code>
                </div>
                <div class="mapping-item" style="background:#ea580c;color:white;">Ch·ªâ huy Ph√≥ Th∆∞·ªùng tr·ª±c ‚Üí
                    <code>super_admin</code>
                </div>
                <div class="mapping-item" style="background:#f97316;color:white;">Ch·ªâ huy Ph√≥ ‚Üí <code>super_admin</code>
                </div>
                <div class="mapping-item" style="background:#fb923c;">Th√†nh vi√™n TT BCH ‚Üí <code>super_admin</code></div>
                <div class="mapping-item" style="background:#fdba74;">Th√†nh vi√™n BCH ‚Üí <code>super_admin</code></div>
                <div class="mapping-item" style="background:#0891b2;color:white;">ƒê·ªôi tr∆∞·ªüng ‚Üí
                    <code>doihinh_admin</code>
                </div>
                <div class="mapping-item" style="background:#06b6d4;color:white;">ƒê·ªôi ph√≥ ‚Üí <code>doihinh_admin</code>
                </div>
                <div class="mapping-item" style="background:#8b5cf6;color:white;">ƒêT/ƒêP K√Ω s·ª± T·∫øt ‚Üí
                    <code>kysutet_admin</code>
                </div>
                <div class="mapping-item" style="background:#16a34a;color:white;">Chi·∫øn sƒ© ‚Üí <code>member</code></div>
            </div>

            <h4 style="margin-top:15px; color:#8bb8e8;">üè∑Ô∏è Team ID Mapping (10 ƒê·ªôi h√¨nh ch√≠nh th·ª©c):</h4>
            <div class="mapping-grid" style="margin-top:10px;">
                <div class="mapping-item">Xu√¢n t·ª± h√†o ‚Üí <code>xuan-tu-hao</code></div>
                <div class="mapping-item">Xu√¢n b·∫£n s·∫Øc ‚Üí <code>xuan-ban-sac</code></div>
                <div class="mapping-item">Xu√¢n s·∫ª chia ‚Üí <code>xuan-se-chia</code></div>
                <div class="mapping-item">Xu√¢n g·∫Øn k·∫øt ‚Üí <code>xuan-gan-ket</code></div>
                <div class="mapping-item">Xu√¢n chi·∫øn sƒ© ‚Üí <code>xuan-chien-si</code></div>
                <div class="mapping-item">T·∫øt vƒÉn minh ‚Üí <code>tet-van-minh</code></div>
                <div class="mapping-item" style="grid-column: span 2;">T∆∞ v·∫•n v√† gi·∫£ng d·∫°y ph√°p lu·∫≠t c·ªông ƒë·ªìng ‚Üí
                    <code>tu-van-giang-day-phap-luat</code>
                </div>
                <div class="mapping-item">Giai ƒëi·ªáu m√πa xu√¢n ‚Üí <code>giai-dieu-mua-xuan</code></div>
                <div class="mapping-item">Vi√™n ch·ª©c tr·∫ª ‚Üí <code>vien-chuc-tre</code></div>
                <div class="mapping-item">H·∫≠u c·∫ßn ‚Üí <code>hau-can</code></div>
            </div>

            <h4 style="margin-top:15px; color:#fbbf24;">‚≠ê Ban Ch·ªâ huy & K√Ω s·ª± T·∫øt:</h4>
            <div class="mapping-grid" style="margin-top:10px;">
                <div class="mapping-item" style="background:#4a90d9;color:white;">Ban Ch·ªâ huy Chi·∫øn d·ªãch ‚Üí
                    <code>ban-chi-huy-chien-dich</code>
                </div>
                <div class="mapping-item" style="background:#8b5cf6;color:white;">K√Ω s·ª± T·∫øt ‚Üí <code>ky-su-tet</code>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXNF0XzvXvgDBD1okTm14P21pYHPxz-xA",
            authDomain: "xtn-2026.firebaseapp.com",
            projectId: "xtn-2026",
            storageBucket: "xtn-2026.firebasestorage.app",
            messagingSenderId: "995363622017",
            appId: "1:995363622017:web:90b23cf7a1dbf5bf52d5c9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Import function
        window.importToFirebase = async function () {
            if (!window.jsonData || window.jsonData.length === 0) {
                alert('‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu! H√£y upload file Excel tr∆∞·ªõc.');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën import ${window.jsonData.length} chi·∫øn sƒ© v√†o Firebase?\n\n‚ö†Ô∏è Thao t√°c n√†y s·∫Ω GHI ƒê√à d·ªØ li·ªáu n·∫øu email ƒë√£ t·ªìn t·∫°i.`)) {
                return;
            }

            const progressDiv = document.getElementById('import-progress');
            const statusEl = document.getElementById('import-status');
            const countEl = document.getElementById('import-count');
            const barEl = document.getElementById('import-bar');

            progressDiv.style.display = 'block';

            let successCount = 0;
            let errorCount = 0;
            const total = window.jsonData.length;

            for (let i = 0; i < total; i++) {
                const person = window.jsonData[i];
                try {
                    const emailDocId = person.email.replace(/[.#$[\]]/g, '_');
                    await setDoc(doc(db, 'xtn_users', emailDocId), {
                        ...person,
                        imported: true,
                        created_at: serverTimestamp()
                    });
                    successCount++;
                } catch (e) {
                    console.error('Import error:', person.email, e);
                    errorCount++;
                }

                // Update progress
                const percent = Math.round(((i + 1) / total) * 100);
                countEl.textContent = `${i + 1}/${total}`;
                barEl.style.width = percent + '%';
                statusEl.textContent = `ƒêang import... ${percent}%`;
            }

            // Done
            statusEl.textContent = `‚úÖ Ho√†n t·∫•t!`;
            barEl.style.background = 'linear-gradient(90deg,#4ade80,#22c55e)';

            alert(`üéâ Import ho√†n t·∫•t!\n\n‚úÖ Th√†nh c√¥ng: ${successCount}\n‚ùå L·ªói: ${errorCount}\n\nT·ªïng: ${total} chi·∫øn sƒ©`);
        };
    </script>

    <script>
        let jsonData = [];
        window.jsonData = jsonData;
        let duplicateEmails = [];

        // Team name to ID mapping - DANH S√ÅCH CH√çNH TH·ª®C XTN 2026
        const TEAM_MAPPING = {
            // 10 ƒê·ªôi h√¨nh ch√≠nh th·ª©c
            'xu√¢n t·ª± h√†o': 'xuan-tu-hao',
            'xuan tu hao': 'xuan-tu-hao',
            'xu√¢n b·∫£n s·∫Øc': 'xuan-ban-sac',
            'xuan ban sac': 'xuan-ban-sac',
            'xu√¢n s·∫ª chia': 'xuan-se-chia',
            'xuan se chia': 'xuan-se-chia',
            'xu√¢n g·∫Øn k·∫øt': 'xuan-gan-ket',
            'xuan gan ket': 'xuan-gan-ket',
            'xu√¢n chi·∫øn sƒ©': 'xuan-chien-si',
            'xuan chien si': 'xuan-chien-si',
            't·∫øt vƒÉn minh': 'tet-van-minh',
            'tet van minh': 'tet-van-minh',
            't∆∞ v·∫•n v√† gi·∫£ng d·∫°y ph√°p lu·∫≠t c·ªông ƒë·ªìng': 'tu-van-giang-day-phap-luat',
            'tu van va giang day phap luat cong dong': 'tu-van-giang-day-phap-luat',
            't∆∞ v·∫•n ph√°p lu·∫≠t': 'tu-van-giang-day-phap-luat',
            'giai ƒëi·ªáu m√πa xu√¢n': 'giai-dieu-mua-xuan',
            'giai dieu mua xuan': 'giai-dieu-mua-xuan',
            'vi√™n ch·ª©c tr·∫ª': 'vien-chuc-tre',
            'vien chuc tre': 'vien-chuc-tre',
            'h·∫≠u c·∫ßn': 'hau-can',
            'hau can': 'hau-can',
            // Ban Ch·ªâ huy v√† K√Ω s·ª± T·∫øt
            'ban ch·ªâ huy chi·∫øn d·ªãch': 'ban-chi-huy-chien-dich',
            'ban chi huy chien dich': 'ban-chi-huy-chien-dich',
            'ban ch·ªâ huy': 'ban-chi-huy-chien-dich',
            'ban chi huy': 'ban-chi-huy-chien-dich',
            'k√Ω s·ª± t·∫øt': 'ky-su-tet',
            'ky su tet': 'ky-su-tet',
        };

        // Mapping ng∆∞·ª£c: team_id -> t√™n ƒë·ªôi h√¨nh chu·∫©n (ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng)
        const TEAM_ID_TO_NAME = {
            'xuan-tu-hao': 'Xu√¢n t·ª± h√†o',
            'xuan-ban-sac': 'Xu√¢n b·∫£n s·∫Øc',
            'xuan-se-chia': 'Xu√¢n s·∫ª chia',
            'xuan-gan-ket': 'Xu√¢n g·∫Øn k·∫øt',
            'xuan-chien-si': 'Xu√¢n chi·∫øn sƒ©',
            'tet-van-minh': 'T·∫øt vƒÉn minh',
            'tu-van-giang-day-phap-luat': 'T∆∞ v·∫•n v√† gi·∫£ng d·∫°y ph√°p lu·∫≠t c·ªông ƒë·ªìng',
            'giai-dieu-mua-xuan': 'Giai ƒëi·ªáu m√πa xu√¢n',
            'vien-chuc-tre': 'Vi√™n ch·ª©c tr·∫ª',
            'hau-can': 'H·∫≠u c·∫ßn',
            'ban-chi-huy-chien-dich': 'Ban Ch·ªâ huy Chi·∫øn d·ªãch',
            'ky-su-tet': 'K√Ω s·ª± T·∫øt',
        };

        // Position to role mapping - ƒê√öNG THEO H·ªÜ TH·ªêNG
        const POSITION_TO_ROLE = {
            'ch·ªâ huy tr∆∞·ªüng': 'super_admin',
            'chi huy truong': 'super_admin',
            'ch·ªâ huy ph√≥ th∆∞·ªùng tr·ª±c': 'super_admin',
            'chi huy pho thuong truc': 'super_admin',
            'ch·ªâ huy ph√≥': 'super_admin',
            'chi huy pho': 'super_admin',
            'th√†nh vi√™n th∆∞·ªùng tr·ª±c ban ch·ªâ huy': 'super_admin',
            'thanh vien thuong truc ban chi huy': 'super_admin',
            'th√†nh vi√™n ban ch·ªâ huy': 'super_admin',
            'thanh vien ban chi huy': 'super_admin',
            'ƒë·ªôi tr∆∞·ªüng': 'doihinh_admin',
            'doi truong': 'doihinh_admin',
            'ƒë·ªôi ph√≥': 'doihinh_admin',
            'doi pho': 'doihinh_admin',
            'chi·∫øn sƒ©': 'member',
            'chien si': 'member',
            'th√†nh vi√™n': 'member',
            'thanh vien': 'member',
        };

        // Chu·∫©n h√≥a t√™n ch·ª©c v·ª• v·ªÅ ƒë√∫ng format
        const POSITION_NORMALIZE = {
            'ch·ªâ huy tr∆∞·ªüng': 'Ch·ªâ huy Tr∆∞·ªüng',
            'chi huy truong': 'Ch·ªâ huy Tr∆∞·ªüng',
            'ch·ªâ huy ph√≥ th∆∞·ªùng tr·ª±c': 'Ch·ªâ huy Ph√≥ Th∆∞·ªùng tr·ª±c',
            'chi huy pho thuong truc': 'Ch·ªâ huy Ph√≥ Th∆∞·ªùng tr·ª±c',
            'ch·ªâ huy ph√≥': 'Ch·ªâ huy Ph√≥',
            'chi huy pho': 'Ch·ªâ huy Ph√≥',
            'th√†nh vi√™n th∆∞·ªùng tr·ª±c ban ch·ªâ huy': 'Th√†nh vi√™n Th∆∞·ªùng tr·ª±c Ban Ch·ªâ huy',
            'thanh vien thuong truc ban chi huy': 'Th√†nh vi√™n Th∆∞·ªùng tr·ª±c Ban Ch·ªâ huy',
            'th√†nh vi√™n ban ch·ªâ huy': 'Th√†nh vi√™n Ban Ch·ªâ huy',
            'thanh vien ban chi huy': 'Th√†nh vi√™n Ban Ch·ªâ huy',
            'ƒë·ªôi tr∆∞·ªüng': 'ƒê·ªôi tr∆∞·ªüng',
            'doi truong': 'ƒê·ªôi tr∆∞·ªüng',
            'ƒë·ªôi ph√≥': 'ƒê·ªôi ph√≥',
            'doi pho': 'ƒê·ªôi ph√≥',
            'chi·∫øn sƒ©': 'Chi·∫øn sƒ©',
            'chien si': 'Chi·∫øn sƒ©',
            'th√†nh vi√™n': 'Chi·∫øn sƒ©',
            'thanh vien': 'Chi·∫øn sƒ©',
        };

        // H√†m chu·∫©n h√≥a position
        function normalizePosition(position) {
            if (!position) return 'Chi·∫øn sƒ©';
            const normalized = position.toLowerCase().trim();

            // T√¨m ƒë√∫ng trong mapping
            for (const [key, value] of Object.entries(POSITION_NORMALIZE)) {
                if (normalized.includes(key) || key.includes(normalized)) {
                    return value;
                }
            }

            // Fallback: gi·ªØ nguy√™n ho·∫∑c m·∫∑c ƒë·ªãnh
            return position.trim() || 'Chi·∫øn sƒ©';
        }

        document.getElementById('file-input').addEventListener('change', handleFile);

        // Drag and drop
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#6bb3ff';
            uploadArea.style.background = 'rgba(255,255,255,0.2)';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#4a90d9';
            uploadArea.style.background = 'rgba(255,255,255,0.1)';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4a90d9';
            uploadArea.style.background = 'rgba(255,255,255,0.1)';
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                convertToJSON(rawData);
            };
            reader.readAsArrayBuffer(file);
        }

        function getTeamId(teamName) {
            if (!teamName) return '';
            const normalized = teamName.toLowerCase()
                .replace(/ƒë·ªôi h√¨nh\s*/gi, '')
                .replace(/ƒë·ªôi\s*/gi, '')
                .trim();

            // Find matching team
            for (const [key, value] of Object.entries(TEAM_MAPPING)) {
                if (normalized.includes(key) || key.includes(normalized)) {
                    return value;
                }
            }

            // Fallback: convert to slug
            return normalized
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
        }

        function getRole(position, teamId) {
            if (!position) return 'member';
            const normalized = position.toLowerCase().trim();

            // ƒê·∫∑c bi·ªát: ƒê·ªôi tr∆∞·ªüng/ƒê·ªôi ph√≥ K√Ω s·ª± T·∫øt c√≥ role kysutet_admin
            if (teamId === 'ky-su-tet') {
                if (normalized.includes('ƒë·ªôi tr∆∞·ªüng') || normalized.includes('doi truong') ||
                    normalized.includes('ƒë·ªôi ph√≥') || normalized.includes('doi pho')) {
                    return 'kysutet_admin';
                }
            }

            for (const [key, value] of Object.entries(POSITION_TO_ROLE)) {
                if (normalized.includes(key)) {
                    return value;
                }
            }
            return 'member';
        }

        function convertToJSON(rawData) {
            const emailSet = new Set();
            duplicateEmails = [];
            const errors = [];
            jsonData = [];

            rawData.forEach((row, index) => {
                const name = row['H·ªç v√† t√™n'] || row['name'] || row['Name'] || row['H·ªç t√™n'] || '';
                const email = (row['Email'] || row['email'] || '').toLowerCase().trim();
                const mssv = row['MSSV'] || row['mssv'] || '';
                const phone = row['S·ªë ƒëi·ªán tho·∫°i'] || row['SƒêT'] || row['phone'] || '';
                const teamName = row['ƒê·ªôi h√¨nh'] || row['team'] || row['Team'] || '';
                const position = row['Ch·ª©c v·ª•'] || row['position'] || 'Chi·∫øn sƒ©';
                const faculty = row['Khoa/Vi·ªán'] || row['Khoa'] || row['faculty'] || '';

                // Validate
                if (!name || !email) {
                    errors.push({ row: index + 2, name, email, reason: 'Thi·∫øu t√™n ho·∫∑c email' });
                    return;
                }

                // Check duplicate email
                if (emailSet.has(email)) {
                    duplicateEmails.push({ row: index + 2, name, email });
                    return;
                }
                emailSet.add(email);

                // Convert
                const teamId = getTeamId(teamName);
                // L·∫•y t√™n ƒë·ªôi h√¨nh chu·∫©n t·ª´ mapping (∆∞u ti√™n h∆°n input t·ª´ Excel)
                const standardTeamName = TEAM_ID_TO_NAME[teamId] || teamName.replace(/^ƒë·ªôi h√¨nh\s*/i, '').trim() || teamId;
                // Chu·∫©n h√≥a ch·ª©c v·ª•
                const standardPosition = normalizePosition(position);

                jsonData.push({
                    name: name.trim(),
                    mssv: String(mssv).trim(),
                    email: email,
                    phone: String(phone).trim(),
                    faculty: faculty.trim(),
                    position: standardPosition,
                    team_id: teamId,
                    team_name: standardTeamName,
                    role: getRole(position, teamId),
                    status: 'active'
                });
            });

            // Sync to window for Firebase module
            window.jsonData = jsonData;

            // Update UI
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('total-count').textContent = rawData.length;
            document.getElementById('valid-count').textContent = jsonData.length;
            document.getElementById('duplicate-count').textContent = duplicateEmails.length;
            document.getElementById('error-count').textContent = errors.length;

            // Show duplicates
            if (duplicateEmails.length > 0) {
                document.getElementById('duplicates-container').innerHTML = `
                    <div class="duplicates-list">
                        <h4>‚ö†Ô∏è Email tr√πng l·∫∑p (ƒë√£ b·ªè qua):</h4>
                        <ul>
                            ${duplicateEmails.map(d => `<li>D√≤ng ${d.row}: <strong>${d.name}</strong> - ${d.email}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                document.getElementById('duplicates-container').innerHTML = '';
            }

            // Show JSON
            document.getElementById('json-output').textContent = JSON.stringify(jsonData, null, 2);
            document.getElementById('result-area').classList.add('show');

            // Build preview table
            buildPreviewTable();
        }

        function buildPreviewTable() {
            const table = document.getElementById('preview-table');
            let html = `
                <thead style="background:#2d6cb5;">
                    <tr>
                        <th style="padding:10px; color:#fff;">STT</th>
                        <th style="padding:10px; color:#fff;">H·ªç t√™n</th>
                        <th style="padding:10px; color:#fff;">Email</th>
                        <th style="padding:10px; color:#fff;">MSSV</th>
                        <th style="padding:10px; color:#fff;">Team ID</th>
                        <th style="padding:10px; color:#fff;">Role</th>
                    </tr>
                </thead>
                <tbody>
            `;

            jsonData.slice(0, 50).forEach((item, i) => {
                html += `
                    <tr style="background:${i % 2 ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.1)'};">
                        <td style="padding:8px;">${i + 1}</td>
                        <td style="padding:8px;">${item.name}</td>
                        <td style="padding:8px; color:#6bb3ff;">${item.email}</td>
                        <td style="padding:8px;">${item.mssv}</td>
                        <td style="padding:8px; color:#ffc107;">${item.team_id}</td>
                        <td style="padding:8px;">${item.role}</td>
                    </tr>
                `;
            });

            if (jsonData.length > 50) {
                html += `<tr><td colspan="6" style="padding:10px; text-align:center; color:#8bb8e8;">... v√† ${jsonData.length - 50} d√≤ng kh√°c</td></tr>`;
            }

            html += '</tbody>';
            table.innerHTML = html;
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('json-tab').style.display = tab === 'json' ? 'block' : 'none';
            document.getElementById('preview-tab').style.display = tab === 'preview' ? 'block' : 'none';
        }

        function copyJSON() {
            navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2));
            alert('‚úÖ ƒê√£ copy JSON v√†o clipboard!');
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'xtn_users_' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
        }

        function downloadCleanExcel() {
            const ws = XLSX.utils.json_to_sheet(jsonData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Chi·∫øn sƒ© XTN');
            XLSX.writeFile(wb, 'XTN_Clean_' + new Date().toISOString().slice(0, 10) + '.xlsx');
        }
    </script>
</body>

</html>