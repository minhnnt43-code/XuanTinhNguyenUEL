<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Thông tin Chiến dịch - XTN 2026</title>
    <link rel="icon" type="image/png" href="images/logoxtn.png">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Merriweather:wght@700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/dashboard.css">

    <style>
        /* Page specific styles */
        body {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: #166534;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #666;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #166534;
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .info-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .info-section h2 {
            color: #166534;
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dcfce7;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-section h2 i {
            color: #22c55e;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #22c55e;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group small {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .list-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .list-item input {
            flex: 1;
        }

        .list-item button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-remove-item {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-add-item {
            background: #dcfce7;
            color: #166534;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 500;
        }

        .btn-add-item:hover {
            background: #bbf7d0;
        }

        .save-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-save {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
        }

        .btn-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .status-message.success {
            background: #dcfce7;
            color: #166534;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #dc2626;
            display: block;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            text-align: center;
        }

        .loading-spinner i {
            font-size: 3rem;
            color: #22c55e;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Upload Dropzone */
        .upload-dropzone {
            border: 3px dashed #22c55e;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.5);
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: #16a34a;
            background: rgba(34, 197, 94, 0.1);
            transform: scale(1.02);
        }

        .upload-dropzone.dragover {
            border-style: solid;
        }
    </style>

    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Mammoth for DOCX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>

<body>
    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>

    <div class="admin-container">
        <!-- Back link -->
        <a href="dashboard.html" class="back-link">
            <i class="fa-solid fa-arrow-left"></i> Quay lại Dashboard
        </a>

        <!-- Header -->
        <div class="page-header">
            <h1><i class="fa-solid fa-gear"></i> Quản lý Thông tin Chiến dịch</h1>
            <p>Cập nhật thông tin để AI Chatbot trả lời chính xác cho ứng viên</p>
        </div>

        <!-- AI Upload Section -->
        <div class="info-section"
            style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 2px dashed #22c55e;">
            <h2><i class="fa-solid fa-wand-magic-sparkles"></i> AI Nhập liệu Thông minh</h2>
            <p style="margin-bottom: 15px; color: #666;">Upload file PDF hoặc Word chứa thông tin chiến dịch, AI sẽ tự
                động phân tích và điền form!</p>

            <div class="upload-area" id="upload-area">
                <input type="file" id="file-upload" accept=".pdf,.doc,.docx,.txt" style="display: none;">
                <div class="upload-dropzone" id="upload-dropzone">
                    <i class="fa-solid fa-cloud-arrow-up"
                        style="font-size: 3rem; color: #22c55e; margin-bottom: 15px;"></i>
                    <p><strong>Kéo thả file vào đây</strong></p>
                    <p style="font-size: 0.9rem; color: #666;">hoặc click để chọn file</p>
                    <p style="font-size: 0.8rem; color: #999; margin-top: 10px;">Hỗ trợ: PDF, Word (.doc, .docx), Text
                        (.txt)</p>
                </div>
            </div>

            <div id="upload-progress" style="display: none; margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fa-solid fa-robot fa-bounce" style="font-size: 2rem; color: #22c55e;"></i>
                    <div style="flex: 1;">
                        <p id="progress-text" style="font-weight: 600; color: #166534;">Đang phân tích...</p>
                        <div
                            style="background: #e5e7eb; border-radius: 10px; height: 8px; margin-top: 5px; overflow: hidden;">
                            <div id="progress-bar"
                                style="background: linear-gradient(90deg, #22c55e, #16a34a); height: 100%; width: 0%; transition: width 0.3s;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ai-result"
                style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 10px; border-left: 4px solid #22c55e;">
                <p style="color: #166534; font-weight: 600;"><i class="fa-solid fa-check-circle"></i> <span
                        id="ai-result-text">AI đã phân tích xong!</span></p>
            </div>
        </div>

        <!-- Thông tin chung -->
        <div class="info-section">
            <h2><i class="fa-solid fa-info-circle"></i> Thông tin Chiến dịch</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Tên chiến dịch</label>
                    <input type="text" id="campaign-name" placeholder="VD: Xuân Tình Nguyện UEL 2026">
                </div>
                <div class="form-group">
                    <label>Trường/Đơn vị</label>
                    <input type="text" id="campaign-school" placeholder="VD: Đại học Kinh tế - Luật">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Thời gian bắt đầu</label>
                    <input type="date" id="campaign-start">
                </div>
                <div class="form-group">
                    <label>Thời gian kết thúc</label>
                    <input type="date" id="campaign-end">
                </div>
            </div>
            <div class="form-group">
                <label>Địa điểm hoạt động</label>
                <input type="text" id="campaign-location" placeholder="VD: TP. Hồ Chí Minh và các tỉnh lân cận">
            </div>
            <div class="form-group">
                <label>Mô tả chiến dịch</label>
                <textarea id="campaign-description" placeholder="Mô tả ngắn gọn về chiến dịch..."></textarea>
            </div>
        </div>

        <!-- Điều kiện tham gia -->
        <div class="info-section">
            <h2><i class="fa-solid fa-clipboard-check"></i> Điều kiện Tham gia</h2>
            <div class="list-input-group" id="conditions-list">
                <!-- Dynamic items -->
            </div>
            <button class="btn-add-item" onclick="addListItem('conditions-list')">
                <i class="fa-solid fa-plus"></i> Thêm điều kiện
            </button>
        </div>

        <!-- Quyền lợi -->
        <div class="info-section">
            <h2><i class="fa-solid fa-gift"></i> Quyền lợi Chiến sĩ</h2>
            <div class="list-input-group" id="benefits-list">
                <!-- Dynamic items -->
            </div>
            <button class="btn-add-item" onclick="addListItem('benefits-list')">
                <i class="fa-solid fa-plus"></i> Thêm quyền lợi
            </button>
        </div>

        <!-- Đội hình -->
        <div class="info-section">
            <h2><i class="fa-solid fa-people-group"></i> Danh sách Đội hình</h2>
            <div class="list-input-group" id="teams-list">
                <!-- Dynamic items -->
            </div>
            <button class="btn-add-item" onclick="addListItem('teams-list')">
                <i class="fa-solid fa-plus"></i> Thêm đội hình
            </button>
            <small style="margin-top: 10px; display: block;">Lưu ý: Đội hình này dùng cho chatbot. Đội hình chính thức
                quản lý trong Dashboard > Đội hình.</small>
        </div>

        <!-- Quy trình đăng ký -->
        <div class="info-section">
            <h2><i class="fa-solid fa-list-ol"></i> Quy trình Đăng ký</h2>
            <div class="list-input-group" id="steps-list">
                <!-- Dynamic items -->
            </div>
            <button class="btn-add-item" onclick="addListItem('steps-list')">
                <i class="fa-solid fa-plus"></i> Thêm bước
            </button>
        </div>

        <!-- Liên hệ -->
        <div class="info-section">
            <h2><i class="fa-solid fa-address-book"></i> Thông tin Liên hệ</h2>
            <div class="form-group">
                <label>Link Fanpage Facebook</label>
                <input type="url" id="contact-fanpage" placeholder="https://facebook.com/...">
            </div>
            <div class="form-group">
                <label>Email liên hệ</label>
                <input type="email" id="contact-email" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Hotline / Số điện thoại</label>
                <input type="text" id="contact-hotline" placeholder="VD: 0123 456 789 hoặc 'Liên hệ qua Fanpage'">
            </div>
        </div>

        <!-- Ban Chỉ huy -->
        <div class="info-section">
            <h2><i class="fa-solid fa-user-tie"></i> Ban Chỉ huy</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Chỉ huy trưởng</label>
                    <input type="text" id="leader-chief" placeholder="VD: Nguyễn Văn A - SĐT/Email">
                </div>
                <div class="form-group">
                    <label>Chỉ huy phó</label>
                    <input type="text" id="leader-deputy" placeholder="VD: Trần Thị B - SĐT/Email">
                </div>
            </div>
            <div class="form-group">
                <label>Thư ký</label>
                <input type="text" id="leader-secretary" placeholder="VD: Lê Văn C - SĐT/Email">
            </div>
            <div class="form-group">
                <label>Thành viên BCH khác</label>
                <textarea id="leader-members"
                    placeholder="Liệt kê các thành viên BCH khác, mỗi người một dòng..."></textarea>
            </div>
        </div>

        <!-- FAQ Tự do - Thông tin bổ sung -->
        <div class="info-section">
            <h2><i class="fa-solid fa-question-circle"></i> Thông tin Bổ sung (FAQ)</h2>
            <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                Thêm các thông tin khác mà ứng viên có thể hỏi. VD: "Có cần kinh nghiệm không?", "Chiến dịch có học bổng
                không?"...
            </p>
            <div class="list-input-group" id="faq-list">
                <!-- Dynamic items -->
            </div>
            <button class="btn-add-item" onclick="addFaqItem()">
                <i class="fa-solid fa-plus"></i> Thêm câu hỏi/trả lời
            </button>
        </div>

        <!-- Save Actions -->
        <div class="save-actions">
            <button id="btn-save-all" class="btn-save">
                <i class="fa-solid fa-save"></i> Lưu tất cả thông tin
            </button>
        </div>

        <div id="status-message" class="status-message"></div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { db, auth } from './js/firebase.js';
        import { doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const COLLECTION = 'xtn_settings';
        const DOC_ID = 'campaign_info';

        // Timeout safety - ẩn loading sau 5 giây nếu có lỗi
        setTimeout(() => {
            document.getElementById('loading-overlay')?.classList.add('hidden');
        }, 5000);

        // Check auth
        onAuthStateChanged(auth, async (user) => {
            const hideLoading = () => document.getElementById('loading-overlay')?.classList.add('hidden');

            if (!user) {
                hideLoading();
                window.location.href = 'login.html';
                return;
            }

            try {
                // Check role
                const userDoc = await getDoc(doc(db, 'xtn_users', user.uid));
                const userData = userDoc.data();
                if (!['super_admin', 'admin', 'bch_truong'].includes(userData?.role)) {
                    hideLoading();
                    alert('Bạn không có quyền truy cập trang này!');
                    window.location.href = 'dashboard.html';
                    return;
                }

                // Load data
                await loadData();
            } catch (error) {
                console.error('Auth/Load error:', error);
                hideLoading();
            }
        });

        // Load existing data
        async function loadData() {
            try {
                const docSnap = await getDoc(doc(db, COLLECTION, DOC_ID));
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Fill form
                    document.getElementById('campaign-name').value = data.name || '';
                    document.getElementById('campaign-school').value = data.school || '';
                    document.getElementById('campaign-start').value = data.startDate || '';
                    document.getElementById('campaign-end').value = data.endDate || '';
                    document.getElementById('campaign-location').value = data.location || '';
                    document.getElementById('campaign-description').value = data.description || '';

                    // Lists
                    loadList('conditions-list', data.conditions || []);
                    loadList('benefits-list', data.benefits || []);
                    loadList('teams-list', data.teams || []);
                    loadList('steps-list', data.registerSteps || []);

                    // Contact
                    document.getElementById('contact-fanpage').value = data.contact?.fanpage || '';
                    document.getElementById('contact-email').value = data.contact?.email || '';
                    document.getElementById('contact-hotline').value = data.contact?.hotline || '';

                    // Leadership
                    document.getElementById('leader-chief').value = data.leadership?.chief || '';
                    document.getElementById('leader-deputy').value = data.leadership?.deputy || '';
                    document.getElementById('leader-secretary').value = data.leadership?.secretary || '';
                    document.getElementById('leader-members').value = data.leadership?.members || '';

                    // FAQ
                    loadFaqList(data.faq || []);
                } else {
                    // Add some default items
                    addListItem('conditions-list');
                    addListItem('benefits-list');
                    addListItem('teams-list');
                    addListItem('steps-list');
                    window.addFaqItem(); // Default FAQ item
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus('Lỗi tải dữ liệu: ' + error.message, 'error');
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Load list items
        function loadList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (items.length === 0) {
                window.addListItem(containerId);
            } else {
                items.forEach(item => window.addListItem(containerId, item));
            }
        }

        // Add list item
        window.addListItem = function (containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Nhập nội dung...">
                <button class="btn-remove-item" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        };

        // Get list values
        function getListValues(containerId) {
            const items = document.querySelectorAll(`#${containerId} .list-item input`);
            return Array.from(items).map(i => i.value.trim()).filter(v => v);
        }

        // FAQ Functions
        window.addFaqItem = function (question = '', answer = '') {
            const container = document.getElementById('faq-list');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.style.cssText = 'flex-direction: column; gap: 8px; align-items: stretch;';
            div.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" class="faq-question" value="${question}" placeholder="Câu hỏi: VD: Có cần kinh nghiệm không?" style="flex: 1;">
                    <button class="btn-remove-item" onclick="this.parentElement.parentElement.remove()">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <input type="text" class="faq-answer" value="${answer}" placeholder="Trả lời: VD: Không cần, chiến dịch sẽ đào tạo..." style="margin-left: 0;">
            `;
            container.appendChild(div);
        };

        function getFaqValues() {
            const items = document.querySelectorAll('#faq-list .list-item');
            const faq = [];
            items.forEach(item => {
                const q = item.querySelector('.faq-question')?.value?.trim();
                const a = item.querySelector('.faq-answer')?.value?.trim();
                if (q && a) {
                    faq.push({ question: q, answer: a });
                }
            });
            return faq;
        }

        function loadFaqList(faqData) {
            const container = document.getElementById('faq-list');
            container.innerHTML = '';
            if (faqData.length === 0) {
                window.addFaqItem();
            } else {
                faqData.forEach(item => window.addFaqItem(item.question || '', item.answer || ''));
            }
        }

        // Save all
        document.getElementById('btn-save-all').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-all');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang lưu...';

            try {
                const data = {
                    name: document.getElementById('campaign-name').value.trim(),
                    school: document.getElementById('campaign-school').value.trim(),
                    startDate: document.getElementById('campaign-start').value,
                    endDate: document.getElementById('campaign-end').value,
                    location: document.getElementById('campaign-location').value.trim(),
                    description: document.getElementById('campaign-description').value.trim(),
                    conditions: getListValues('conditions-list'),
                    benefits: getListValues('benefits-list'),
                    teams: getListValues('teams-list'),
                    registerSteps: getListValues('steps-list'),
                    contact: {
                        fanpage: document.getElementById('contact-fanpage').value.trim(),
                        email: document.getElementById('contact-email').value.trim(),
                        hotline: document.getElementById('contact-hotline').value.trim()
                    },
                    // Ban Chỉ huy
                    leadership: {
                        chief: document.getElementById('leader-chief').value.trim(),
                        deputy: document.getElementById('leader-deputy').value.trim(),
                        secretary: document.getElementById('leader-secretary').value.trim(),
                        members: document.getElementById('leader-members').value.trim()
                    },
                    // FAQ tự do
                    faq: getFaqValues(),
                    updatedAt: serverTimestamp()
                };

                await setDoc(doc(db, COLLECTION, DOC_ID), data);
                showStatus('✅ Đã lưu thông tin thành công! AI Chatbot sẽ cập nhật ngay.', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showStatus('❌ Lỗi lưu dữ liệu: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save"></i> Lưu tất cả thông tin';
            }
        });

        function showStatus(message, type) {
            const el = document.getElementById('status-message');
            el.textContent = message;
            el.className = 'status-message ' + type;
            setTimeout(() => { el.className = 'status-message'; }, 5000);
        }

        // ============================================================
        // AI FILE UPLOAD & PARSING
        // ============================================================
        import { callGroqAI } from './js/groq-api.js';

        // Set PDF.js worker
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Setup dropzone events
        const dropzone = document.getElementById('upload-dropzone');
        const fileInput = document.getElementById('file-upload');

        dropzone?.addEventListener('click', () => fileInput?.click());

        dropzone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone?.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone?.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFileUpload(file);
        });

        fileInput?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFileUpload(file);
        });

        // Handle file upload
        async function handleFileUpload(file) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const resultDiv = document.getElementById('ai-result');
            const resultText = document.getElementById('ai-result-text');

            // Show progress
            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            progressBar.style.width = '10%';
            progressText.textContent = `Đang đọc file: ${file.name}...`;

            try {
                // Step 1: Extract text from file
                progressBar.style.width = '30%';
                progressText.textContent = 'Đang trích xuất nội dung...';

                const text = await extractTextFromFile(file);

                if (!text || text.length < 50) {
                    throw new Error('Không thể đọc nội dung file hoặc file quá ngắn');
                }

                // Step 2: Send to AI for parsing
                progressBar.style.width = '60%';
                progressText.textContent = 'AI đang phân tích thông tin...';

                const parsedData = await parseWithAI(text);

                // Step 3: Fill form with parsed data
                progressBar.style.width = '90%';
                progressText.textContent = 'Đang điền form...';

                fillFormWithData(parsedData);

                // Done
                progressBar.style.width = '100%';
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultText.textContent = 'AI đã phân tích và điền form thành công! Vui lòng kiểm tra và chỉnh sửa nếu cần.';

            } catch (error) {
                console.error('File processing error:', error);
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.style.borderLeftColor = '#dc2626';
                resultText.innerHTML = `<span style="color:#dc2626">❌ Lỗi: ${error.message}</span>`;
            }
        }

        // Extract text from different file types
        async function extractTextFromFile(file) {
            const fileType = file.name.split('.').pop().toLowerCase();

            if (fileType === 'txt') {
                return await file.text();
            }

            if (fileType === 'pdf') {
                return await extractFromPDF(file);
            }

            if (fileType === 'docx' || fileType === 'doc') {
                return await extractFromDOCX(file);
            }

            throw new Error('Định dạng file không được hỗ trợ: ' + fileType);
        }

        // Extract text from PDF using PDF.js
        async function extractFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let text = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }

            return text;
        }

        // Extract text from DOCX using mammoth.js
        async function extractFromDOCX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer });
            return result.value;
        }

        // Parse text with AI to extract structured data
        async function parseWithAI(text) {
            const systemPrompt = `Bạn là AI chuyên phân tích văn bản chiến dịch tình nguyện.
Nhiệm vụ: Trích xuất thông tin từ văn bản và trả về JSON có cấu trúc sau:

{
    "name": "Tên chiến dịch",
    "school": "Trường/Đơn vị tổ chức",
    "startDate": "YYYY-MM-DD",
    "endDate": "YYYY-MM-DD",
    "location": "Địa điểm hoạt động",
    "description": "Mô tả ngắn về chiến dịch",
    "conditions": ["Điều kiện 1", "Điều kiện 2"],
    "benefits": ["Quyền lợi 1", "Quyền lợi 2"],
    "teams": ["Tên đội hình 1", "Tên đội hình 2"],
    "registerSteps": ["Bước 1", "Bước 2"],
    "contact": {
        "fanpage": "Link facebook",
        "email": "Email liên hệ",
        "hotline": "Số điện thoại"
    },
    "leadership": {
        "chief": "Tên chỉ huy trưởng",
        "deputy": "Tên chỉ huy phó",
        "secretary": "Tên thư ký",
        "members": "Danh sách thành viên BCH khác"
    },
    "faq": [
        {"question": "Câu hỏi mẫu?", "answer": "Câu trả lời"}
    ]
}

QUY TẮC:
- CHỈ trả về JSON thuần, không có markdown hay text khác
- Định dạng ngày: YYYY-MM-DD (VD: 2025-12-15)
- Nếu không tìm thấy thông tin nào đó, để chuỗi rỗng "" hoặc mảng rỗng []
- Trích xuất TẤT CẢ thông tin có thể từ văn bản`;

            const prompt = `Phân tích văn bản sau và trích xuất thông tin chiến dịch:\n\n${text.substring(0, 30000)}`;

            const result = await callGroqAI(prompt, {
                systemPrompt,
                temperature: 0.2,
                maxTokens: 2000
            });

            if (!result.success) {
                throw new Error('AI không thể phân tích: ' + result.error);
            }

            // Parse JSON from response
            let jsonStr = result.content;
            // Remove markdown code blocks if present
            jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error('JSON parse error:', e, jsonStr);
                throw new Error('Không thể phân tích kết quả AI trả về');
            }
        }

        // Fill form with parsed data
        function fillFormWithData(data) {
            // Basic info
            if (data.name) document.getElementById('campaign-name').value = data.name;
            if (data.school) document.getElementById('campaign-school').value = data.school;
            if (data.startDate) document.getElementById('campaign-start').value = data.startDate;
            if (data.endDate) document.getElementById('campaign-end').value = data.endDate;
            if (data.location) document.getElementById('campaign-location').value = data.location;
            if (data.description) document.getElementById('campaign-description').value = data.description;

            // Lists
            if (data.conditions?.length) loadList('conditions-list', data.conditions);
            if (data.benefits?.length) loadList('benefits-list', data.benefits);
            if (data.teams?.length) loadList('teams-list', data.teams);
            if (data.registerSteps?.length) loadList('steps-list', data.registerSteps);

            // Contact
            if (data.contact?.fanpage) document.getElementById('contact-fanpage').value = data.contact.fanpage;
            if (data.contact?.email) document.getElementById('contact-email').value = data.contact.email;
            if (data.contact?.hotline) document.getElementById('contact-hotline').value = data.contact.hotline;

            // Leadership
            if (data.leadership?.chief) document.getElementById('leader-chief').value = data.leadership.chief;
            if (data.leadership?.deputy) document.getElementById('leader-deputy').value = data.leadership.deputy;
            if (data.leadership?.secretary) document.getElementById('leader-secretary').value = data.leadership.secretary;
            if (data.leadership?.members) document.getElementById('leader-members').value = data.leadership.members;

            // FAQ
            if (data.faq?.length) loadFaqList(data.faq);
        }
    </script>
</body>

</html>