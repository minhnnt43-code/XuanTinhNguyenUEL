<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Avatar Chiến dịch Xuân tình nguyện UEL 2026</title>
    <meta name="description" content="Tạo avatar chiến dịch Xuân Tình nguyện UEL 2026">

    <!-- Favicon -->
    <link rel="icon" href="images/logo.png" type="image/png">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        @font-face {
            font-family: 'UTM Avo';
            src: url('fonts/UTM%20Avo.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'UTM Avo';
            src: url('fonts/UTM%20AvoBold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }

        body {
            font-family: 'UTM Avo', 'Montserrat', sans-serif;
        }
    </style>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Toast Notification System -->
    <script src="js/toast.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/animations.css">

    <style>
        body {
            background: linear-gradient(135deg, #FFFDE7 0%, #FFF9C4 50%, #FFEB3B 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .avatar-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #00723F;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .two-column {
                flex-direction: column;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .card {
                padding: 15px !important;
            }

            .canvas-wrapper {
                max-width: 100%;
            }

            #avatar-canvas {
                max-width: 100%;
                height: auto;
                touch-action: none;
            }

            .btn-block {
                padding: 16px !important;
                font-size: 1.1rem !important;
            }

            .zoom-slider {
                height: 50px !important;
            }

            /* Counter badge */
            .counter-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: linear-gradient(135deg, #00723F, #00a758);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-top: 10px;
            }
        }

        /* Counter badge cho cả desktop */
        .counter-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #00723F, #00a758);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(0, 114, 63, 0.3);
        }

        .counter-badge i {
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <div class="avatar-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fa-solid fa-image"></i> Tạo Avatar Xuân tình nguyện UEL 2026</h1>
            <p>Tải ảnh chân dung lên, điều chỉnh và tải về avatar chiến dịch!</p>
            <div class="counter-badge" id="avatar-counter">
                <i class="fa-solid fa-download"></i>
                <span id="counter-number">0</span> avatar đã được tạo
            </div>
        </div>

        <!-- Main content -->
        <div class="two-column">
            <!-- Cột điều khiển -->
            <div class="left-col">
                <div class="card">
                    <h3><i class="fa-solid fa-upload"></i> 1. Tải ảnh lên</h3>
                    <div id="avatar-upload-area">
                        <!-- Desktop: Label for drag/drop -->
                        <label for="avatar-upload" class="upload-label" id="avatar-upload-label">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <p>Nhấn hoặc kéo ảnh vào đây</p>
                            <small>Hỗ trợ: JPG, PNG, WEBP</small>
                        </label>
                        <!-- Mobile: Native file input -->
                        <input type="file" id="avatar-upload" accept="image/*">
                        <p id="avatar-upload-status"></p>
                    </div>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <h3><i class="fa-solid fa-sliders"></i> 2. Điều chỉnh</h3>
                    <div class="form-group">
                        <label>Phóng to / Thu nhỏ</label>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="var s=document.getElementById('avatar-zoom'); s.value=Math.max(0.5, parseFloat(s.value)-0.1); s.dispatchEvent(new Event('input'));"
                                style="width:50px; height:50px; font-size:1.5rem; touch-action:manipulation;">
                                −
                            </button>
                            <input type="range" id="avatar-zoom" class="zoom-slider" min="0.5" max="3" step="0.1"
                                value="1" style="flex:1; touch-action:pan-x; height:40px;">
                            <button type="button" class="btn btn-secondary"
                                onclick="var s=document.getElementById('avatar-zoom'); s.value=Math.min(3, parseFloat(s.value)+0.1); s.dispatchEvent(new Event('input'));"
                                style="width:50px; height:50px; font-size:1.5rem; touch-action:manipulation;">
                                +
                            </button>
                        </div>
                    </div>
                    <div class="tip-box">
                        <i class="fa-solid fa-lightbulb"></i>
                        <strong>Mẹo:</strong> Dùng nút + / − hoặc kéo ảnh trên khung xem trước.
                    </div>
                </div>
            </div>

            <!-- Cột xem trước -->
            <div class="right-col">
                <div class="card preview-card">
                    <h3><i class="fa-solid fa-eye"></i> 3. Xem trước & Tải về</h3>
                    <div class="canvas-wrapper avatar-wrapper">
                        <canvas id="avatar-canvas" width="2000" height="2000"></canvas>
                    </div>
                    <button id="btn-avatar-download" class="btn btn-success btn-block" disabled>
                        <i class="fa-solid fa-download"></i> Tải Avatar về máy
                    </button>
                    <button id="btn-avatar-reset" class="btn btn-secondary btn-block"
                        style="margin-top: 10px; display: none;">
                        <i class="fa-solid fa-rotate-left"></i> Tạo lại từ đầu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer
        style="text-align: center; margin: 40px auto 20px; padding: 20px 30px; color: #00723F; font-size: 0.95rem; font-weight: 500; max-width: 1200px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 2px solid #00723F;">
        <p style="margin: 0;">Chiến dịch Xuân tình nguyện Trường Đại học Kinh tế - Luật, ĐHQG-HCM năm 2026</p>
    </footer>

    <!-- Firebase (chỉ dùng cho counter, không cần đăng nhập) -->
    <script type="module">
        import { db } from './js/firebase.js';
        import { doc, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { initAvatarCanvas, handleAvatarUpload, resetAvatarFull } from './js/dashboard-avatar.js';

        // Counter document reference
        const counterRef = doc(db, 'xtn_settings', 'avatar_counter');

        // Load counter on page load
        async function loadCounter() {
            try {
                const counterDoc = await getDoc(counterRef);
                const count = counterDoc.exists() ? (counterDoc.data().count || 0) : 0;
                document.getElementById('counter-number').textContent = count.toLocaleString('vi-VN');
            } catch (e) {
                console.warn('[Avatar] Counter load failed:', e);
            }
        }

        // Increment counter on download
        async function incrementCounter() {
            try {
                await setDoc(counterRef, { count: increment(1) }, { merge: true });
                // Update UI immediately
                const el = document.getElementById('counter-number');
                const current = parseInt(el.textContent.replace(/\./g, '')) || 0;
                el.textContent = (current + 1).toLocaleString('vi-VN');
            } catch (e) {
                console.warn('[Avatar] Counter increment failed:', e);
            }
        }

        // HD Download with counter
        function downloadAvatarHD() {
            const canvas = document.getElementById('avatar-canvas');
            if (!canvas) return;

            // Export with maximum quality
            const link = document.createElement('a');
            link.download = 'AvatarXTN2026.png';
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();

            // Increment counter
            incrementCounter();
        }

        // Khởi tạo trực tiếp - KHÔNG cần đăng nhập
        document.addEventListener('DOMContentLoaded', () => {
            // Init avatar canvas
            initAvatarCanvas();

            // Load counter
            loadCounter();

            // Event listeners
            document.getElementById('avatar-upload').addEventListener('change', handleAvatarUpload);
            document.getElementById('btn-avatar-download').addEventListener('click', downloadAvatarHD);
            document.getElementById('btn-avatar-reset').addEventListener('click', resetAvatarFull);
        });
    </script>
</body>

</html>